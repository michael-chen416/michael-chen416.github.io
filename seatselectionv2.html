<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seat Selection</title>
  <style>
    /* ===== Reset & Chat-Widget Wrapper ===== */
    body {
      margin: 0;
      padding: 0;
      background: #FFFFFF;
      font-family: 'Georgia', serif;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .chat-widget {
      width: 100%;
      max-width: 320px;
      margin: 20px;
      padding: 10px;
      background: #FFFFFF;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      box-sizing: border-box;
      overflow-y: auto;
    }

    /* ===== Header (“STAGE”) ===== */
    .screen {
      margin: 0 auto 20px;
      width: 100%;
      height: 30px;
      background: #E30613;
      border: 2px solid #E30613;
      color: #FFF;
      font-weight: bold;
      line-height: 30px;
      text-align: center;
    }

    /* ===== Seat Grid ===== */
    .seat-grid {
      display: grid;
      grid-template-columns: auto repeat(8, 1fr);
      grid-gap: 8px;
      align-items: center;
      /* no horizontal scroll: seats shrink to fit */
    }
    .seat {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #484848;
      color: #FFF;
      border: 1px solid #666;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
      font-size: 1em;
    }
    .seat.taken {
      background: #E30613;
      cursor: not-allowed;
    }
    .seat.selected {
      background: #26ff00;
    }

    /* ===== Row Labels ===== */
    .label {
      text-align: center;
      font-weight: bold;
      color: #000;
    }

    /* ===== Legend ===== */
    .legend {
      margin-top: 10px;
      text-align: center;
      color: #000;
    }
    .legend span {
      margin: 0 10px;
      display: inline-block;
    }
    .legend .box {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      margin-right: 5px;
      display: inline-block;
      border: 1px solid #000;
    }

    /* ===== Output & Buttons ===== */
    .output {
      text-align: center;
      margin-top: 20px;
      font-size: 18px;
      color: #000;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 15px;
    }
    .action-buttons button {
      flex: 0 0 auto;
      padding: 8px 16px;
      font-size: 14px;
      border: 1px solid #E30613;
      background: #E30613;
      color: #FFF;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      min-width: 80px;
    }
    .action-buttons button:hover {
      background: #FFF;
      color: #E30613;
    }
    #previewBtn,
    #lockInBtn,
    #clearAllBtn,
    #checkoutBtn {
      display: none;
    }

    /* ===== 3D Preview Modal ===== */
    #threeModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
    }
    #threeModal > div {
      position: relative;
      width: 80%; max-width: 800px;
      height: 500px;
      margin: 60px auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #threeCanvas {
      width: 100%; height: 100%;
    }
    #threeModal button {
      position: absolute;
      top: 10px; right: 10px;
      padding: 6px 12px;
      z-index: 2;
    }

    /* ===== Gift Modal & Confetti ===== */
    .confetti {
      position: fixed; top: 0;
      width: 10px; height: 10px;
      opacity: 0.9; animation: fall linear forwards;
      z-index: 9999; border-radius: 50%;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    #giftModal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1002;
    }
    #giftModal.centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .giftbox {
      width: 120px; height: 120px;
      margin-bottom: 20px;
      background: url('https://i.imgur.com/T8hN4fR.gif') no-repeat center/contain;
    }

    /* ===== Checkout ===== */
    #checkoutPage {
      display: none;
      background: #F9F9F9;
      border: 1px solid #E30613;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }
    #checkoutPage h2 {
      margin: 0 0 20px;
      color: #E30613;
      text-align: center;
      font-size: 1.6em;
    }
    #checkoutSummary p {
      margin: 8px 0; color: #000; line-height: 1.4;
    }
    #checkoutSummary hr {
      border: 0; border-top: 1px solid #CCC; margin: 12px 0;
    }
    .checkout-buttons {
      display: flex;
      justify-content: center;
      gap: 24px;   /* ↑ space between buttons */
      margin-top: 20px;
    }
    .checkout-buttons button {
      padding: 10px 20px;
      border: 1px solid #E30613;
      background: #E30613;
      color: #FFF;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      /* remove any per‐button margin */
      margin: 0;
    }
    .checkout-buttons button:hover {
      background: #FFF;
      color: #E30613;
    }

    /* ===== Optional: Shrink font on narrow widget ===== */
    @media (max-width: 320px) {
      .seat { font-size: 0.8rem; }
      .action-buttons button { font-size: 12px; padding: 6px 12px; }
    }
  </style>
</head>
<body>
  <div class="chat-widget">
    <!-- ============== SELECTION PAGE ============== -->
    <div id="selectionPage">
      <div class="screen">STAGE</div>
      <div class="seat-grid" id="seatMap"></div>

      <div class="legend">
        <span><span class="box" style="background:#484848;"></span> Available</span>
        <span><span class="box" style="background:#26ff00;"></span> Selected</span>
        <span><span class="box" style="background:#E30613"></span> Taken</span>
      </div>

      <div class="output" id="output">No seats selected.</div>

      <div class="action-buttons">
        <button id="previewBtn"  onclick="previewSeat()">Preview</button>
        <button id="lockInBtn"   onclick="lockInSeat()">Lock In Seats</button>
        <button id="clearAllBtn" onclick="clearAll()">Clear All</button>
        <button id="checkoutBtn" onclick="showCheckout()">Checkout</button>
      </div>

      <!-- 3D Preview Modal -->
      <div id="threeModal">
        <div>
          <button onclick="document.getElementById('threeModal').style.display='none'">Close</button>
          <canvas id="threeCanvas"></canvas>
        </div>
      </div>

      <!-- Gift Modal -->
      <div id="giftModal">
        <div class="giftbox"></div>
        <canvas id="giftCanvas" width="300" height="300"></canvas>
        <div id="giftText"></div>
        <button onclick="closeGiftModal()">Close</button>
      </div>
    </div>
    <!-- =========== /SELECTION PAGE =========== -->

    <!-- ============= CHECKOUT PAGE ============= -->
    <div id="checkoutPage">
      <h2>Order Summary</h2>
      <div id="checkoutSummary"></div>
      <div class="checkout-buttons">
        <button id="confirmBtn">Confirm Purchase</button>
        <button id="backBtn">Back</button>
      </div>
    </div>
    <!-- =========== /CHECKOUT PAGE =========== -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
    const seatMapEl    = document.getElementById("seatMap");
    const previewBtn   = document.getElementById("previewBtn");
    const lockInBtn    = document.getElementById("lockInBtn");
    const clearAllBtn  = document.getElementById("clearAllBtn");
    const checkoutBtn  = document.getElementById("checkoutBtn");
    const outputEl     = document.getElementById("output");

    // Now only 4 rows: A-D
    const rows       = ['A','B','C','D'];
    const cols       = 8;
    const takenSeats = ['A1','B5','C3','D8','D2'];
    const prices     = { A:150, B:150, C:100, D:100 };
    const specialSeats = { B2:"Free Drink Voucher", C7:"Backstage Tour Pass", D8:"VIP Lounge Access" };

    let selectedSeats = [];
    let lockedSeatIds = [];
    let hasLockedIn = false;

    // Build grid & multi-select
    rows.forEach(r => {
      // Row label
      const lbl = document.createElement("div");
      lbl.className = "label";
      lbl.textContent = r;
      seatMapEl.appendChild(lbl);

      for (let i = 1; i <= cols; i++) {
        const id = `${r}${i}`;
        const seat = document.createElement("div");
        seat.className   = "seat";
        seat.textContent = i;
        seat.dataset.id  = id;
        if (takenSeats.includes(id)) seat.classList.add("taken");

        seat.addEventListener("click", ()=> {
          if (hasLockedIn) {
            alert("You’ve already locked in; no changes allowed.");
            return;
          }
          if (!seat.classList.contains("taken")) {
            if (seat.classList.contains("selected")) {
              seat.classList.remove("selected");
              selectedSeats = selectedSeats.filter(s=>s!==seat);
            } else {
              seat.classList.add("selected");
              selectedSeats.push(seat);
            }
          }
          // Update UI
          if (selectedSeats.length) {
            const ids   = selectedSeats.map(s=>s.dataset.id);
            const total = ids.reduce((sum,id)=> sum + prices[id[0]], 0);
            outputEl.textContent = `Selected Seats: ${ids.join(", ")} | Total: $${total}`;
            previewBtn.style.display  = "block";
            lockInBtn.style.display   = "block";
            clearAllBtn.style.display = "block";
          } else {
            outputEl.textContent = "No seats selected.";
            [previewBtn, lockInBtn, clearAllBtn].forEach(b=>b.style.display="none");
          }
        });

        seatMapEl.appendChild(seat);
      }
    });

    // 3D Preview setup
    let renderer, scene, camera, seats3D = [];
    function initThreeJS() {
      const canvas = document.getElementById("threeCanvas");
      const rect   = canvas.parentElement.getBoundingClientRect();
      renderer = new THREE.WebGLRenderer({ canvas });
      renderer.setSize(rect.width, rect.height);
      renderer.setPixelRatio(window.devicePixelRatio);

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      camera = new THREE.PerspectiveCamera(60, rect.width/rect.height, 0.1, 1000);
      camera.position.set(0, 5, 20);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(10,10,10);
      scene.add(light, new THREE.AmbientLight(0x404040));

      // Stage
      const stage = new THREE.Mesh(
        new THREE.BoxGeometry(10,5,0.5),
        new THREE.MeshStandardMaterial({ color:0xff5555 })
      );
      stage.position.set(0,2.5,-20);
      scene.add(stage);

      rows.forEach((r,ri) => {
        for (let c=1; c<=cols; c++){
          const s = new THREE.Mesh(
            new THREE.BoxGeometry(0.5,0.5,0.5),
            new THREE.MeshStandardMaterial({ color:0x4444ff })
          );
          s.position.set((c-cols/2)*1.2, 0.25, ri*1.2);
          s.name = `${r}${c}`;
          scene.add(s);
          seats3D.push(s);
        }
      });

      animate();
    }
    function animate() {
      requestAnimationFrame(animate);
      if (renderer && scene && camera) renderer.render(scene, camera);
    }

    // Preview last selected or locked seat
    function previewSeat() {
      if (!selectedSeats.length && !lockedSeatIds.length) {
        alert("No seat to preview."); return;
      }
      const last = hasLockedIn
        ? lockedSeatIds[lockedSeatIds.length-1]
        : selectedSeats[selectedSeats.length-1].dataset.id;

      document.getElementById("threeModal").style.display = "block";
      if (!renderer) initThreeJS();

      seats3D.forEach(s=> {
        s.material.color.set(s.name===last?0x00ff00:0x4444ff);
      });
      const tgt = seats3D.find(s=>s.name===last);
      if (tgt) {
        camera.position.set(tgt.position.x, tgt.position.y+1.2, tgt.position.z+1.5);
        camera.lookAt(0,2.5,-20);
      }
    }

    // Clear all
    function clearAll(){
      selectedSeats.forEach(s=>s.classList.remove("selected"));
      selectedSeats = [];
      outputEl.textContent = "No seats selected.";
      [previewBtn, lockInBtn, clearAllBtn].forEach(b=>b.style.display="none");
    }

    // Lock in & enable checkout
    function lockInSeat(){
      if (!selectedSeats.length || hasLockedIn) return;
      const ids = selectedSeats.map(s=>s.dataset.id);
      const total = ids.reduce((sum,id)=>sum+prices[id[0]],0);
      selectedSeats.forEach(s=>{
        const id=s.dataset.id;
        if (specialSeats[id]){ showGiftModal(specialSeats[id]); launchConfetti(); }
        s.classList.add("taken");
        s.classList.remove("selected");
      });
      lockedSeatIds=ids.slice();
      hasLockedIn=true;
      outputEl.textContent=`Locked in: ${ids.join(", ")} | Total: $${total}`;
      lockInBtn.style.display="none"; clearAllBtn.style.display="none";
      previewBtn.style.display="block"; checkoutBtn.style.display="block";
    }

    // Checkout
    function generateOrderNumber(){ return 'ORD'+Math.floor(100000+Math.random()*900000); }
    function showCheckout(){
      document.getElementById("selectionPage").style.display="none";
      const sumEl = document.getElementById("checkoutSummary");
      const orderNum     = generateOrderNumber();
      const purchaseDT   = new Date().toLocaleString();
      const eventDetails = "Live Concert – March 15, 2026 @ 7:00 PM";
      const email        = "johndoe@example.com";
      const phone        = "(555) 123-4567";
      const seatsList    = lockedSeatIds.join(", ");
      const totalAmt     = lockedSeatIds.reduce((sum,id)=>sum+prices[id[0]],0);
      sumEl.innerHTML = `
        <p><strong>Order #:</strong> ${orderNum}</p>
        <p><strong>Purchase Date:</strong> ${purchaseDT}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <hr>
        <p><strong>Event:</strong> ${eventDetails}</p>
        <p><strong>Seats:</strong> ${seatsList}</p>
        <p><strong>Total:</strong> $${totalAmt.toFixed(2)}</p>
      `;
      document.getElementById("checkoutPage").style.display="block";
    }
    function cancelCheckout(){
      document.getElementById("checkoutPage").style.display="none";
      document.getElementById("selectionPage").style.display="block";
    }
    document.getElementById("confirmBtn").addEventListener("click",()=>{
      alert("Purchase confirmed! 😊"); location.reload();
    });
    document.getElementById("backBtn").addEventListener("click", cancelCheckout);

    // Gift & Confetti
    let giftRenderer, giftScene, giftCamera, lidGroup, sparkles=[];
    let openAngle=0, sparkleStartTime=null;
    function initGiftBox(){
      const canvas = document.getElementById("giftCanvas");
      giftRenderer = new THREE.WebGLRenderer({ canvas, alpha:true });
      giftRenderer.setSize(300,300); giftRenderer.setPixelRatio(window.devicePixelRatio);
      giftScene  = new THREE.Scene();
      giftCamera = new THREE.PerspectiveCamera(45,1,0.1,1000);
      giftCamera.position.set(0,2.5,5); giftCamera.lookAt(0,0.5,0);
      const dl=new THREE.DirectionalLight(0xffffff,1);
      dl.position.set(3,5,2); giftScene.add(dl, new THREE.AmbientLight(0x808080));
      const redMat=new THREE.MeshStandardMaterial({ color:0xff5555 });
      const goldMat=new THREE.MeshStandardMaterial({ color:0xffd700 });
      const bw=2, bh=1.5, bd=2, wt=0.1, by=-bh/2;
      const bottom=new THREE.Mesh(new THREE.BoxGeometry(bw,wt,bd),redMat);
      bottom.position.y=by*2; giftScene.add(bottom);
      [['back',[0,by,-bd/2+wt/2]],['front',[0,by,bd/2-wt/2]],
       ['left',[-bw/2+wt/2,by,0]],['right',[bw/2-wt/2,by,0]]]
      .forEach(([_,pos])=>{
        const geo=(_==='back'||_==='front')
          ? new THREE.BoxGeometry(bw,bh,wt)
          : new THREE.BoxGeometry(wt,bh,bd);
        const m=new THREE.Mesh(geo,redMat);
        m.position.set(...pos); giftScene.add(m);
      });
      [[0,by,bd/2-wt/2],[0,by,-bd/2+wt/2]].forEach(pos=>{
        const r=new THREE.Mesh(new THREE.BoxGeometry(0.2,bh,wt),goldMat);
        r.position.set(...pos); giftScene.add(r);
      });
      [[bw/2-wt/2,by,0],[-bw/2+wt/2,by,0]].forEach(pos=>{
        const r=new THREE.Mesh(new THREE.BoxGeometry(wt,bh,0.2),goldMat);
        r.position.set(...pos); giftScene.add(r);
      });
      lidGroup=new THREE.Group(); lidGroup.position.set(0,0,-1);
      const lid=new THREE.Mesh(new THREE.BoxGeometry(2.1,0.3,2.1),redMat);
      lid.position.set(0,0.15,1);
      const lr1=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.3,2.1),goldMat);
      const lr2=new THREE.Mesh(new THREE.BoxGeometry(2.1,0.3,0.2),goldMat);
      lr1.position.set(0,0.25,1); lr2.position.set(0,0.25,1);
      lidGroup.add(lid,lr1,lr2); giftScene.add(lidGroup);
      const geo=new THREE.BufferGeometry();
      const posArr=new Float32Array(200*3), velArr=[];
      for(let i=0;i<200;i++){
        posArr[i*3]   = (Math.random()-0.5)*1.2;
        posArr[i*3+1] = Math.random()*3;
        posArr[i*3+2] = (Math.random()-0.5)*1.2;
        velArr.push((Math.random()-0.5)*0.02,0.02+Math.random()*0.03,(Math.random()-0.5)*0.02);
      }
      geo.setAttribute('position', new THREE.BufferAttribute(posArr,3));
      geo.setAttribute('velocity', new THREE.BufferAttribute(new Float32Array(velArr),3));
      const mat=new THREE.PointsMaterial({
        color:0xffffff, size:0.2,
        blending:THREE.AdditiveBlending,
        depthWrite:false, transparent:true, opacity:1
      });
      const pts=new THREE.Points(geo,mat); pts.position.y=1.2;
      giftScene.add(pts); sparkles.push(pts);
      sparkleStartTime=null; openAngle=0;
      animateGiftBox();
    }
    function animateGiftBox(ts){
      requestAnimationFrame(animateGiftBox);
      if(openAngle<Math.PI/2){ openAngle+=0.02; lidGroup.rotation.x=-openAngle; }
      if(sparkles.length && sparkleStartTime===null) sparkleStartTime=ts;
      if(sparkles.length && sparkleStartTime!==null){
        const elapsed=(ts-sparkleStartTime)/1000;
        const pa=sparkles[0].geometry.getAttribute('position');
        const va=sparkles[0].geometry.getAttribute('velocity');
        for(let i=0;i<pa.count;i++){
          pa.array[i*3]+=va.array[i*3];
          pa.array[i*3+1]+=va.array[i*3+1];
          pa.array[i*3+2]+=va.array[i*3+2];
        }
        pa.needsUpdate=true;
        sparkles[0].material.opacity=Math.max(0,1-elapsed*0.3);
      }
      giftRenderer.render(giftScene,giftCamera);
    }
    function showGiftModal(prize){
      const gm=document.getElementById("giftModal");
      gm.classList.add("centered");
      document.getElementById("giftText").innerText=`🎁 You won: ${prize}!`;
      initGiftBox();
    }
    function closeGiftModal(){
      document.getElementById("giftModal").classList.remove("centered");
    }
    function launchConfetti(){
      const colors=['#ff7e5f','#feb47b','#86e3ce','#d0e6a5','#f5d491','#ffaaa5'];
      for(let i=0;i<80;i++){
        const c=document.createElement("div");
        c.className="confetti";
        c.style.left=Math.random()*100+"vw";
        c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
        c.style.animationDuration=(2+Math.random()*2)+"s";
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),4000);
      }
    }
  </script>
</body>
</html>
